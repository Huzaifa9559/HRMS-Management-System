name: Nginx Reverse Proxy Deployment

on:
  push:
    branches:
      - main
    paths:
      - "nginx/**"
      - ".github/workflows/nginx-deploy.yml"
  workflow_dispatch:
  workflow_run:
    workflows: ["Backend Pipeline", "Frontend Pipeline"]
    types:
      - completed

jobs:
  deploy-nginx:
    runs-on: ubuntu-latest
    # Only run if triggered by workflow_run (after backend/frontend), push, or manual dispatch
    # Note: Secret validation happens in the first step
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
    environment:
      name: Production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Required Secrets
        run: |
          if [ -z "${{ secrets.DO_HOST }}" ] || [ -z "${{ secrets.DO_USERNAME }}" ] || [ -z "${{ secrets.DO_SSH_KEY }}" ]; then
            echo "âŒ Error: Missing required GitHub Secrets"
            echo ""
            echo "ğŸ“ To fix this:"
            echo "1. Go to your GitHub repository"
            echo "2. Navigate to: Settings â†’ Secrets and variables â†’ Actions"
            echo "3. Add the following secrets:"
            echo "   - DO_HOST: Your Digital Ocean droplet IP address"
            echo "   - DO_USERNAME: SSH username (usually 'root')"
            echo "   - DO_SSH_KEY: Your SSH private key"
            echo ""
            echo "ğŸ’¡ This workflow will fail until secrets are configured."
            exit 1
          fi
          echo "âœ… All required secrets are configured and available"

      - name: Update Container Ports (Bind to localhost)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_PORT || 22 }}
          script: |
            echo "ğŸ”§ Updating container ports to bind to localhost only..."

            # Determine base directory
            BASE_DIR="/opt/hrms"
            if [ ! -d "$BASE_DIR" ]; then
              BASE_DIR="$HOME/hrms"
              if [ ! -d "$BASE_DIR" ]; then
                BASE_DIR="/tmp/hrms"
              fi
            fi

            # Update backend docker-compose.yml
            if [ -f "$BASE_DIR/backend/docker-compose.yml" ]; then
              cd $BASE_DIR/backend
              if grep -q '"8000:8000"' docker-compose.yml; then
                sed -i 's/"8000:8000"/"127.0.0.1:8000:8000"/' docker-compose.yml
                echo "âœ… Backend ports updated"
              fi
            else
              echo "âš ï¸  Backend docker-compose.yml not found, skipping port update"
            fi

            # Update frontend docker-compose.yml
            if [ -f "$BASE_DIR/frontend/docker-compose.yml" ]; then
              cd $BASE_DIR/frontend
              if grep -q '"80:80"' docker-compose.yml; then
                sed -i 's/"80:80"/"127.0.0.1:80:80"/' docker-compose.yml
                echo "âœ… Frontend ports updated"
              fi
            else
              echo "âš ï¸  Frontend docker-compose.yml not found, skipping port update"
            fi

            # Restart containers with new port bindings
            echo "ğŸ”„ Restarting containers with new port bindings..."
            cd $BASE_DIR/backend && (docker compose restart backend 2>/dev/null || docker-compose restart backend 2>/dev/null) || echo "âš ï¸  Backend container not running"
            cd $BASE_DIR/frontend && (docker compose restart frontend 2>/dev/null || docker-compose restart frontend 2>/dev/null) || echo "âš ï¸  Frontend container not running"
            echo "âœ… Container restart attempted"

      - name: Create parent directories on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_PORT || 22 }}
          script: |
            # Create directories with sudo if needed, or check if they exist
            if [ ! -d "/opt/hrms" ]; then
              sudo mkdir -p /opt/hrms || mkdir -p ~/hrms || mkdir -p /tmp/hrms
            fi
            mkdir -p /opt/hrms/nginx 2>/dev/null || sudo mkdir -p /opt/hrms/nginx || mkdir -p ~/hrms/nginx || mkdir -p /tmp/hrms/nginx
            sudo chmod -R 755 /opt/hrms 2>/dev/null || chmod -R 755 ~/hrms 2>/dev/null || chmod -R 755 /tmp/hrms 2>/dev/null || true
            echo "âœ… Directories created"

      - name: Encode nginx files to base64
        id: encode_files
        run: |
          DOCKER_COMPOSE_B64=$(base64 -w 0 nginx/docker-compose.yml)
          NGINX_CONF_B64=$(base64 -w 0 nginx/nginx.conf)
          NGINX_INITIAL_B64=$(base64 -w 0 nginx/nginx.conf.initial)
          echo "docker_compose_b64=$DOCKER_COMPOSE_B64" >> $GITHUB_OUTPUT
          echo "nginx_conf_b64=$NGINX_CONF_B64" >> $GITHUB_OUTPUT
          echo "nginx_initial_b64=$NGINX_INITIAL_B64" >> $GITHUB_OUTPUT
          echo "âœ… Files encoded"

      - name: Write nginx files to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_PORT || 22 }}
          script: |
            # Determine the base directory
            BASE_DIR="/opt/hrms"
            if [ ! -d "$BASE_DIR" ]; then
              BASE_DIR="$HOME/hrms"
              if [ ! -d "$BASE_DIR" ]; then
                BASE_DIR="/tmp/hrms"
              fi
            fi

            # Decode and write files
            echo "${{ steps.encode_files.outputs.docker_compose_b64 }}" | base64 -d > $BASE_DIR/nginx/docker-compose.yml
            echo "${{ steps.encode_files.outputs.nginx_conf_b64 }}" | base64 -d > $BASE_DIR/nginx/nginx.conf
            echo "${{ steps.encode_files.outputs.nginx_initial_b64 }}" | base64 -d > $BASE_DIR/nginx/nginx.conf.initial

            # Set permissions
            chmod 644 $BASE_DIR/nginx/*.yml $BASE_DIR/nginx/*.conf 2>/dev/null || sudo chmod 644 $BASE_DIR/nginx/*.yml $BASE_DIR/nginx/*.conf || true

            # Verify files
            echo "Files written to: $BASE_DIR/nginx/"
            ls -la $BASE_DIR/nginx/ || ls -la ~/hrms/nginx/ || ls -la /tmp/hrms/nginx/
            echo "âœ… All nginx files copied successfully"

      - name: Setup Nginx Reverse Proxy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_PORT || 22 }}
          script: |
            # Determine base directory
            BASE_DIR="/opt/hrms"
            if [ ! -d "$BASE_DIR" ]; then
              BASE_DIR="$HOME/hrms"
              if [ ! -d "$BASE_DIR" ]; then
                BASE_DIR="/tmp/hrms"
              fi
            fi

            cd $BASE_DIR/nginx

            # Create certbot directories if they don't exist
            mkdir -p certbot/conf certbot/www

            # Create network if it doesn't exist
            docker network create hrms-network --driver bridge 2>/dev/null || true

            # Check if SSL certificates exist
            if [ -f "certbot/conf/live/h-rms.me/fullchain.pem" ]; then
              echo "âœ… SSL certificates found, using full SSL config"
              # Use full nginx.conf with SSL
              if [ ! -f "nginx.conf" ] || [ ! -f "nginx.conf.backup" ]; then
                cp nginx.conf nginx.conf.backup 2>/dev/null || true
              fi
            else
              echo "âš ï¸  SSL certificates not found, using initial config (HTTP only)"
              echo "ğŸ“ To enable SSL, run SSL setup manually first (see NGINX-QUICK-START.md)"
              # Use initial config without SSL redirect
              if [ ! -f "nginx.conf.initial" ]; then
                echo "âŒ nginx.conf.initial not found! Please check nginx files."
                exit 1
              fi
              cp nginx.conf.initial nginx.conf
            fi

            # Start/restart nginx container
            echo "ğŸš€ Starting Nginx reverse proxy..."
            # Check which docker compose command is available
            DOCKER_COMPOSE_CMD=""

            # Test docker-compose (standalone)
            if command -v docker-compose >/dev/null 2>&1; then
              if docker-compose --version >/dev/null 2>&1; then
                DOCKER_COMPOSE_CMD="docker-compose"
                echo "âœ… Found docker-compose (standalone)"
              fi
            fi

            # Test docker compose (plugin) if standalone not found
            if [ -z "$DOCKER_COMPOSE_CMD" ]; then
              if docker compose version >/dev/null 2>&1; then
                DOCKER_COMPOSE_CMD="docker compose"
                echo "âœ… Found docker compose (plugin)"
              fi
            fi

            # If still not found, provide helpful error
            if [ -z "$DOCKER_COMPOSE_CMD" ]; then
              echo "âŒ Docker Compose not found!"
              echo ""
              echo "Checking Docker installation..."
              docker --version || {
                echo "âŒ Docker is not installed or not accessible"
                exit 1
              }
              echo ""
              echo "âš ï¸  Docker Compose is required but not installed."
              echo ""
              echo "ğŸ“ To install Docker Compose on your server:"
              echo "   For Ubuntu/Debian:"
              echo "     sudo apt-get update"
              echo "     sudo apt-get install docker-compose-plugin"
              echo ""
              echo "   Or for standalone version:"
              echo "     sudo apt-get install docker-compose"
              exit 1
            fi

            # Use the detected command
            echo "ğŸš€ Using: $DOCKER_COMPOSE_CMD"
            $DOCKER_COMPOSE_CMD up -d nginx

            # Wait for nginx to be ready
            sleep 5

            # Check if nginx is running
            if docker ps | grep -q hrms-nginx; then
              echo "âœ… Nginx container is running"
            else
              echo "âŒ Nginx container failed to start"
              docker logs hrms-nginx
              exit 1
            fi

            # Test nginx configuration
            docker exec hrms-nginx nginx -t || {
              echo "âŒ Nginx configuration test failed"
              docker logs hrms-nginx
              exit 1
            }

            echo "âœ… Nginx reverse proxy deployed successfully"

      - name: Health Check
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_PORT || 22 }}
          script: |
            echo "ğŸ” Checking container status..."

            # Check if containers are running
            FRONTEND_RUNNING=$(docker ps --filter "name=hrms-frontend" --format "{{.Names}}" | grep -q hrms-frontend && echo "yes" || echo "no")
            BACKEND_RUNNING=$(docker ps --filter "name=hrms-backend" --format "{{.Names}}" | grep -q hrms-backend && echo "yes" || echo "no")
            NGINX_RUNNING=$(docker ps --filter "name=hrms-nginx" --format "{{.Names}}" | grep -q hrms-nginx && echo "yes" || echo "no")

            echo "ğŸ“Š Container Status:"
            echo "  Nginx: $NGINX_RUNNING"
            echo "  Frontend: $FRONTEND_RUNNING"
            echo "  Backend: $BACKEND_RUNNING"
            echo ""

            if [ "$NGINX_RUNNING" = "yes" ]; then
              echo "âœ… Nginx container is running"
              
              # Test nginx configuration
              if docker exec hrms-nginx nginx -t >/dev/null 2>&1; then
                echo "âœ… Nginx configuration is valid"
              else
                echo "âš ï¸  Nginx configuration test failed"
                docker exec hrms-nginx nginx -t
              fi
            else
              echo "âŒ Nginx container is not running"
            fi

            if [ "$FRONTEND_RUNNING" = "yes" ]; then
              echo "âœ… Frontend container is running"
              echo "   Note: Frontend will be accessible once DNS is configured"
            else
              echo "âš ï¸  Frontend container is not running yet"
              echo "   Deploy frontend first using the frontend pipeline"
            fi

            if [ "$BACKEND_RUNNING" = "yes" ]; then
              echo "âœ… Backend container is running"
              echo "   Note: Backend will be accessible once DNS is configured"
            else
              echo "âš ï¸  Backend container is not running yet"
              echo "   Deploy backend first using the backend pipeline"
            fi

            echo ""
            echo "ğŸ“ Next Steps:"
            echo "   1. Deploy backend and frontend containers"
            echo "   2. Configure DNS records (A records for h-rms.me and api.h-rms.me)"
            echo "   3. Set up SSL certificates (see NGINX-QUICK-START.md)"

      - name: Display Status
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_PORT || 22 }}
          script: |
            echo "ğŸ“Š Nginx Deployment Status:"
            echo "=========================="
            docker ps | grep -E "hrms-nginx|hrms-frontend|hrms-backend" || true
            echo ""
            echo "ğŸŒ Network Status:"
            if docker network inspect hrms-network >/dev/null 2>&1; then
              CONTAINER_COUNT=$(docker network inspect hrms-network 2>/dev/null | grep -o '"Name"' | wc -l || echo "0")
              echo "hrms-network: $CONTAINER_COUNT containers connected"
            else
              echo "hrms-network: not found"
            fi
            echo ""
            # Determine base directory
            BASE_DIR="/opt/hrms"
            if [ ! -d "$BASE_DIR" ]; then
              BASE_DIR="$HOME/hrms"
              if [ ! -d "$BASE_DIR" ]; then
                BASE_DIR="/tmp/hrms"
              fi
            fi

            if [ -f "$BASE_DIR/nginx/certbot/conf/live/h-rms.me/fullchain.pem" ]; then
              echo "âœ… SSL certificates are configured"
            else
              echo "âš ï¸  SSL certificates not found - using HTTP only"
              echo "   Run SSL setup to enable HTTPS (see NGINX-QUICK-START.md)"
            fi

            # Clean up unused Docker resources
            echo "ğŸ§¹ Cleaning up unused Docker resources..."

            # Show disk usage before cleanup
            echo "ğŸ“Š Disk usage before cleanup:"
            docker system df

            # Remove stopped containers
            echo "ğŸ—‘ï¸  Removing stopped containers..."
            docker container prune -f

            # Remove unused images (but keep images that are in use)
            echo "ğŸ—‘ï¸  Removing unused images..."
            docker image prune -af --filter "until=24h" || docker image prune -af

            # Remove unused volumes (but keep named volumes)
            echo "ğŸ—‘ï¸  Removing unused volumes..."
            docker volume prune -f

            # Remove unused networks (but keep hrms-network)
            echo "ğŸ—‘ï¸  Removing unused networks..."
            docker network prune -f

            # Show disk usage after cleanup
            echo "ğŸ“Š Disk usage after cleanup:"
            docker system df

            echo "âœ… Docker cleanup completed"
